name: Build CleanerCS2 with XMake
on:
  push:
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: windows
            arch: x64
            config: release
          - os: ubuntu-latest
            platform: linux
            arch: x64
            config: release
    runs-on: ${{ matrix.os }}
    name: Build on ${{ matrix.platform }}-${{ matrix.arch }}

    steps:
      - name: Checkout CleanerCS2
        uses: actions/checkout@v4
        with:
          path: cleaner-cs2
          submodules: recursive

      - name: Checkout HL2SDK-CS2
        uses: actions/checkout@v4
        with:
          repository: alliedmodders/hl2sdk
          ref: 8e3da65bdf33e2dfb04ad57208e85ffc9e93c048
          path: hl2sdk
          submodules: recursive

      - name: Checkout Metamod-Source
        uses: actions/checkout@v4
        with:
          repository: alliedmodders/metamod-source
          ref: master
          path: metamod-source
          submodules: recursive

      # =============================
      # ğŸŸ¢ å®˜æ–¹æ¨èå®‰è£…æ–¹å¼ï¼ˆè·¨å¹³å°ï¼‰
      # =============================
      - name: Install XMake (Official Script)
        run: |
          if ($env:RUNNER_OS -eq "Windows") {
            # Windows: ä½¿ç”¨å®˜æ–¹ PowerShell è„šæœ¬å®‰è£…
            iex "& { $(irm https://xmake.io/install.ps1) }"
          } else {
            # Linux/macOS: ä½¿ç”¨å®˜æ–¹ Bash è„šæœ¬å®‰è£…
            bash <(curl -fsSL https://xmake.io/install.sh)
          }
        shell: powershell

      - name: Verify XMake Installation
        run: |
          echo "XMake version:"
          xmake --version
          if ($LASTEXITCODE -ne 0) {
            Write-Error "XMake not installed correctly!"
            exit 1
          }
        shell: powershell

      - name: Configure with XMake
        working-directory: cleaner-cs2
        run: |
          echo "Configuring for ${{ matrix.platform }}-${{ matrix.arch }}"
          
          if ($env:RUNNER_OS -eq "Windows") {
            xmake f -p windows -a x64 -m release
          } else {
            xmake f -p linux -a x64 -m release
          }
        shell: powershell

      - name: Build project
        working-directory: cleaner-cs2
        run: |
          echo "Building project..."
          xmake build -v
        shell: powershell

      - name: Verify build success
        working-directory: cleaner-cs2
        run: |
          if ($env:RUNNER_OS -eq "Windows") {
            if (Test-Path "build/windows/x64/release/CleanerCS2-Xmake.dll") {
              echo "âœ“ DLL build successful"
              Get-ChildItem -Path "build/windows/x64/release" -Force
            } else {
              echo "âœ— DLL build failed"
              Get-ChildItem -Path "build/windows/x64/release" -Force
              exit 1
            }
          } else {
            if (Test-Path "build/linux/x86_64/release/libCleanerCS2-Xmake.so") {
              echo "âœ“ SO build successful"
              ls -la "build/linux/x86_64/release"
            } else {
              echo "âœ— SO build failed"
              ls -la "build/linux/x86_64/release"
              exit 1
            }
          }
        shell: powershell

      - name: Create package structure
        working-directory: cleaner-cs2
        run: |
          if ($env:RUNNER_OS -eq "Windows") {
            New-Item -ItemType Directory -Path "package" -Force
            if (Test-Path "build/windows/x64/release/CleanerCS2-Xmake.dll") {
              Copy-Item -Path "build/windows/x64/release/CleanerCS2-Xmake.dll" -Destination "package/"
              echo "âœ“ Copied DLL to package"
            }
          } else {
            mkdir -p package
            if (Test-Path "build/linux/x86_64/release/libCleanerCS2-Xmake.so") {
              cp "build/linux/x86_64/release/libCleanerCS2-Xmake.so" package/
              echo "âœ“ Copied SO to package"
            }
          }
        shell: powershell

      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: cleaner-cs2-${{ matrix.platform }}-${{ matrix.arch }}-build
          path: |
            cleaner-cs2/package/**
            cleaner-cs2/build/**
          retention-days: 7

      - name: Upload source code
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: cleaner-cs2-source
          path: |
            cleaner-cs2/src/**
            cleaner-cs2/xmake.lua
            cleaner-cs2/README.md
            cleaner-cs2/LICENSE
          retention-days: 7
